# ТЗ: Интеграция Битрикс24 с Google Apps Script

## Описание задачи

Настроить автоматическое создание смет в Google Drive при переводе сделки CRM в определённую стадию через исходящие и входящие вебхуки Битрикс24.

---

## 1. Техническая архитектура

```
┌──────────────┐                                  ┌──────────────────┐
│  Битрикс24   │  ─── Исходящий вебхук ─────>     │  Google Apps     │
│   (CRM)      │       POST + JSON                │    Script        │
│              │                                   │   (веб-прил.)    │
│              │  <── Входящий вебхук ───────     │                  │
│              │       REST API call              │                  │
└──────────────┘                                  └──────────────────┘
```

**Задача разработчика:** Настроить оба вебхука + создать пользовательские поля.

---

## 2. Создание пользовательских полей в CRM

### 2.1 Требуемые поля

В сущности **"Сделка" (Deal)** создать 3 пользовательских поля:

| Название | Символьный код | Тип | Обязательное | Описание |
|----------|----------------|-----|--------------|----------|
| UID сметы | `UF_CRM_SMETA_UID` | `string` | Нет | Уникальный идентификатор объекта |
| Ссылка на смету | `UF_CRM_SMETA_LINK` | `url` | Нет | URL файла Google Sheets |
| Папка клиента | `UF_CRM_FOLDER_LINK` | `url` | Нет | URL папки в Google Drive |

**Путь:** CRM → Настройки → Настройка полей → Сделка → Добавить поле

### 2.2 Дополнительное поле (если отсутствует)

| Название | Символьный код | Тип | Обязательное |
|----------|----------------|-----|--------------|
| Адрес объекта | `UF_CRM_ADDRESS` | `string` | Да |

---

## 3. Настройка входящего вебхука

### 3.1 Назначение

Входящий вебхук используется для **приёма результата** от Google Apps Script и обновления полей сделки.

### 3.2 Создание вебхука

**Путь:** Приложения → Вебхуки → Входящий вебхук → Добавить

**Настройки:**
- **Название:** `Обновление сметы из GAS`
- **Права доступа:**
  - ✅ `crm` (Доступ к CRM)
  - ✅ `crm.deal.update` (Изменение сделок) — явно указать!

### 3.3 Результат

После создания получите URL вида:
```
https://ваш-домен.bitrix24.ru/rest/1/{TOKEN}/
```

**Этот URL нужен для шага 4.4!**

---

## 4. Настройка исходящего вебхука

### 4.1 Назначение

Исходящий вебхук отправляет данные сделки в Google Apps Script при изменении стадии.

### 4.2 Создание вебхука

**Путь:** Приложения → Вебхуки → Исходящий вебхук → Добавить

### 4.3 Основные параметры

| Параметр | Значение |
|----------|----------|
| **Название** | `Создание сметы в Google` |
| **URL обработчика** | `https://script.google.com/macros/s/AKfycbyjJDkB9_8W8rQKhADQXllx9doq82rFl5o2GUOt_qECzdk_HIyaoY5uJtbACW4A1RzE/exec` |
| **Событие** | `ONCRMDEALUPDATE` (При обновлении сделки) |
| **Фильтр** | Стадия сделки = "Делаем смету" (ID стадии уточнить у менеджеров) |
| **Формат тела** | `JSON` |

### 4.4 Тело запроса (JSON)

**ВАЖНО:** Замените `{ВХОДЯЩИЙ_ВЕБХУК_URL}` на URL из пункта 3.3!

```json
{
  "bitrixDealId": "{=Document:ID}",
  "client": "{=Document:TITLE}",
  "address": "{=Document:UF_CRM_ADDRESS}",
  "phone": "{=Document:PHONE[0].VALUE}",
  "bitrixWebhookUrl": "https://rvt.bitrix24.ru/rest/1/m6s4479uz5swqy22m06tewquchgxzama/"
}
```

**Плейсхолдеры Битрикса:**
- `{=Document:ID}` — ID сделки
- `{=Document:TITLE}` — Название сделки (имя клиента)
- `{=Document:UF_CRM_ADDRESS}` — Адрес объекта (пользовательское поле)
- `{=Document:PHONE[0].VALUE}` — Первый телефон контакта
- `bitrixWebhookUrl` — статичное значение (URL входящего вебхука)

---

## 5. Формат данных

### 5.1 Запрос от Битрикса → GAS

**Метод:** `POST`  
**Content-Type:** `application/json`  
**URL:** `https://script.google.com/macros/s/AKfycbyjJDkB9_8W8rQKhADQXllx9doq82rFl5o2GUOt_qECzdk_HIyaoY5uJtbACW4A1RzE/exec`

**Тело запроса:**
```json
{
  "bitrixDealId": "12345",
  "client": "Иванов Иван Иванович",
  "address": "Москва, ул. Ленина, д. 10, кв. 5",
  "phone": "89991112233",
  "bitrixWebhookUrl": "https://rvt.bitrix24.ru/rest/1/m6s4479uz5swqy22m06tewquchgxzama/"
}
```

### 5.2 Ответ от GAS → Битрикс

**Успешный ответ (200 OK):**
```json
{
  "success": true,
  "data": {
    "uid": "BITRIX-12345",
    "bitrixDealId": "12345",
    "smetaUrl": "https://docs.google.com/spreadsheets/d/1ABC...XYZ/edit",
    "smetaId": "1ABC...XYZ",
    "folderUrl": "https://drive.google.com/drive/folders/1DEF...GHI",
    "action": "CREATE_NEW",
    "status": "Делаем смету",
    "message": "Смета успешно создана. UID: BITRIX-12345"
  }
}
```

**Ответ с ошибкой (200 OK):**
```json
{
  "success": false,
  "error": "managerFolderId пуст - укажи в Тех!L6"
}
```

### 5.3 Обратный вызов от GAS → Битрикс

После создания сметы GAS автоматически вызывает REST API Битрикса:

**URL:** `https://rvt.bitrix24.ru/rest/1/m6s4479uz5swqy22m06tewquchgxzama/crm.deal.update`  
**Метод:** `POST`  
**Content-Type:** `application/json`

**Тело запроса:**
```json
{
  "id": "12345",
  "fields": {
    "UF_CRM_SMETA_UID": "BITRIX-12345",
    "UF_CRM_SMETA_LINK": "https://docs.google.com/spreadsheets/d/1ABC...XYZ/edit",
    "UF_CRM_SMETA_ID": "1ABC...XYZ",
    "UF_CRM_FOLDER_LINK": "https://drive.google.com/drive/folders/1DEF...GHI",
    "COMMENTS": "Смета создана автоматически.\nUID: BITRIX-12345\nСмета успешно создана. UID: BITRIX-12345"
  }
}
```

---

## 6. Логика работы

### 6.1 Триггер

Исходящий вебхук срабатывает при:
- Событие: **Обновление сделки** (`ONCRMDEALUPDATE`)
- Условие: **Стадия сделки** изменилась на "Делаем смету"

### 6.2 Процесс

```
1. Менеджер переводит сделку в стадию "Делаем смету"
   ↓
2. Битрикс отправляет POST-запрос на URL GAS с данными сделки
   ↓
3. GAS обрабатывает запрос (5-15 секунд):
   - Создаёт папку клиента в Google Drive
   - Копирует шаблон сметы
   - Заполняет смету данными
   - Выдаёт доступы
   ↓
4. GAS отправляет результат обратно в Битрикс через входящий вебхук
   ↓
5. Битрикс обновляет поля сделки:
   - UF_CRM_SMETA_UID
   - UF_CRM_SMETA_LINK
   - UF_CRM_FOLDER_LINK
   ↓
6. Менеджер видит заполненные поля со ссылками
```

---

## 7. Обязательные поля в сделке

Перед переводом в стадию "Делаем смету" в сделке ДОЛЖНЫ быть заполнены:

| Поле | Символьный код | Обязательное |
|------|----------------|--------------|
| Название сделки | `TITLE` | ✅ Да |
| Адрес объекта | `UF_CRM_ADDRESS` | ✅ Да |
| Телефон | `PHONE[0].VALUE` | ✅ Да |

Если эти поля пусты — GAS вернёт ошибку.

---

## 8. Проверка работы

### 8.1 Тестовый сценарий

1. Создать тестовую сделку
2. Заполнить:
   - **Название:** "Тестовый Клиент"
   - **Телефон:** "+7 999 111 22 33"
   - **Адрес объекта:** "Москва, ул. Тестовая, д. 1"
3. Перевести в стадию "Делаем смету"
4. Подождать 10-15 секунд
5. Обновить страницу сделки (F5)

**Ожидаемый результат:**
- ✅ Поле **"UID сметы"** = `BITRIX-12345` (где 12345 — ID сделки)
- ✅ Поле **"Ссылка на смету"** = кликабельная ссылка на Google Sheets
- ✅ Поле **"Папка клиента"** = кликабельная ссылка на Google Drive

### 8.2 Отладка

**История вызовов вебхуков:**
Путь: Приложения → Вебхуки → История вызовов

Здесь можно увидеть:
- Отправленные запросы
- Полученные ответы
- HTTP коды
- Ошибки (если есть)

**Ожидаемый код ответа:** `200 OK`

---

## 9. Возможные ошибки

| HTTP код | Описание | Решение |
|----------|----------|---------|
| 200 + success:false | Ошибка в логике GAS | Проверить тело ответа (поле "error") |
| 401 | Unauthorized | Проверить URL веб-приложения GAS |
| 403 | Forbidden | Проверить настройки доступа в GAS |
| 500 | Internal Server Error | Проверить логи GAS |
| Нет запроса | Вебхук не сработал | Проверить фильтр стадии |

---

## 10. Технические требования

### 10.1 Стадия сделки

Уточнить у менеджеров:
- Название стадии: `"Делаем смету"`
- ID стадии: `C5:PREPARATION` (или другой)

В фильтре исходящего вебхука можно указать:
- По названию: `Стадия = "Делаем смету"`
- По ID: `STAGE_ID = "C5:PREPARATION"`

### 10.2 Формат телефона

GAS принимает телефоны в форматах:
- `+7 999 111 22 33`
- `8 999 111 22 33`
- `9991112233`
- `89991112233`
- `79991112233`

Автоматически нормализуется в: `79991112233`

### 10.3 Timeout

- Исходящий вебхук: установить timeout **30 секунд** (минимум)
- GAS обрабатывает запрос: 5-15 секунд в среднем

---

## 11. Контакты

**URL веб-приложения GAS (Production):**
```
https://script.google.com/macros/s/AKfycbyjJDkB9_8W8rQKhADQXllx9doq82rFl5o2GUOt_qECzdk_HIyaoY5uJtbACW4A1RzE/exec
```

**Логи GAS для отладки:**
https://script.google.com/home/projects/1EQiHV_ehdInMzIPRz_SKw63gvD0_XTwqHsGHCQdmsh6RSWjFU_fOwXwI

**Домен Битрикс24:**
```
rvt.bitrix24.ru
```

**Токен входящего вебхука (уже создан):**
```
m6s4479uz5swqy22m06tewquchgxzama
```

---

## 12. Checklist для разработчика

- [ ] Создать поле `UF_CRM_SMETA_UID` (тип: string)
- [ ] Создать поле `UF_CRM_SMETA_LINK` (тип: url)
- [ ] Создать поле `UF_CRM_FOLDER_LINK` (тип: url)
- [ ] Проверить наличие поля `UF_CRM_ADDRESS` (создать если нет)
- [ ] Создать входящий вебхук с правами `crm` + `crm.deal.update`
- [ ] Получить URL входящего вебхука
- [ ] Создать исходящий вебхук на событие `ONCRMDEALUPDATE`
- [ ] Указать URL обработчика GAS
- [ ] Настроить фильтр по стадии "Делаем смету"
- [ ] Вставить JSON-тело запроса с правильным `bitrixWebhookUrl`
- [ ] Выполнить тестовый запуск
- [ ] Проверить заполнение полей в сделке
- [ ] Проверить историю вызовов (код 200 OK)
- [ ] Проверить открытие ссылок на смету и папку

---

## 13. Приложения

### Пример cURL для ручного теста

```bash
curl -X POST \
  'https://script.google.com/macros/s/AKfycbyjJDkB9_8W8rQKhADQXllx9doq82rFl5o2GUOt_qECzdk_HIyaoY5uJtbACW4A1RzE/exec' \
  -H 'Content-Type: application/json' \
  -d '{
    "bitrixDealId": "99999",
    "client": "Тестовый Клиент",
    "address": "Москва, ул. Тестовая, д. 1",
    "phone": "89991112233",
    "bitrixWebhookUrl": "https://rvt.bitrix24.ru/rest/1/m6s4479uz5swqy22m06tewquchgxzama/"
  }'
```

**Ожидаемый ответ:**
```json
{
  "success": true,
  "data": {
    "uid": "BITRIX-99999",
    "smetaUrl": "https://docs.google.com/...",
    "folderUrl": "https://drive.google.com/..."
  }
}
```

---

**Конец ТЗ**

Дата: 25.12.2025  
Версия: 1.0
