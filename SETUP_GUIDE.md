# 📘 Пошаговая инструкция настройки интеграции с Битрикс24

**Для полных новичков** — каждый шаг с подробным описанием 👶

---

## 🎯 Что мы настроим

После настройки при переводе сделки в стадию "Делаем смету" будет автоматически:
1. ✅ Создаваться папка клиента в Google Drive
2. ✅ Копироваться шаблон сметы с заполненными данными
3. ✅ Выдаваться доступ замерщику
4. ✅ В Битрикс возвращаться ссылки на смету и папку

**Время настройки: 10-15 минут**

---

## 📋 ШАГ 1: Подготовка шаблона сметы (5 минут)

### 1.1 Найди шаблон сметы в Google Drive

1. Открой Google Drive: https://drive.google.com
2. Найди файл шаблона сметы (это Excel или Google Sheets файл)
3. Открой его

### 1.2 Получи ID шаблона

1. Посмотри в адресную строку браузера
2. Скопируй ID из URL:

```
https://docs.google.com/spreadsheets/d/1ABC123XYZ456...789/edit
                                      ^^^^^^^^^^^^^^^^^^^^^^^^
                                      ЭТО ID ШАБЛОНА
```

**Пример:** `1ABC123XYZ456789`

3. **Сохрани ID** — он понадобится в шаге 2

---

## 📋 ШАГ 2: Настройка Google Sheets (3 минуты)

### 2.1 Открой рабочую таблицу

1. Открой таблицу проекта (где скрипт установлен)
2. Найди внизу вкладку с названием **"Тех"**
3. Кликни на неё

### 2.2 Заполни обязательные ячейки

Найди слева колонку **L** (латинская буква "эль") и заполни:

```
┌─────┬───────────────────────────────────────────────────┬──────────────────┐
│ L2  │ ID шаблона сметы                                  │ ОБЯЗАТЕЛЬНО!     │
├─────┼───────────────────────────────────────────────────┼──────────────────┤
│ L3  │ БРЕНД-МАР (или СТРОЙМАТ)                          │ Желательно       │
├─────┼───────────────────────────────────────────────────┼──────────────────┤
│ L4  │ Менеджер (например: Иванов Иван)                  │ Желательно       │
├─────┼───────────────────────────────────────────────────┼──────────────────┤
│ L5  │ Замерщик (например: Петров Петр)                  │ Желательно       │
├─────┼───────────────────────────────────────────────────┼──────────────────┤
│ L6  │ ID папки менеджера в Google Drive                 │ ОБЯЗАТЕЛЬНО!     │
├─────┼───────────────────────────────────────────────────┼──────────────────┤
│ L7  │ Email замерщика (например: zamerschik@mail.ru)    │ ОБЯЗАТЕЛЬНО!     │
└─────┴───────────────────────────────────────────────────┴──────────────────┘
```

#### Как получить ID папки менеджера (L6):

1. Открой Google Drive: https://drive.google.com
2. Найди папку, где будут храниться папки клиентов
3. Открой её (двойной клик)
4. Скопируй ID из URL:

```
https://drive.google.com/drive/folders/1XYZ789ABC123...456
                                        ^^^^^^^^^^^^^^^^^^^
                                        ЭТО ID ПАПКИ
```

5. Вставь в ячейку **L6**

### 2.3 Проверка

Убедись, что заполнены **минимум 3 ячейки**:
- ✅ **L2** (ID шаблона)
- ✅ **L6** (ID папки)
- ✅ **L7** (Email замерщика)

---

## 📋 ШАГ 3: Настройка Битрикс24 — Поля (3 минуты)

### 3.1 Открой настройки полей

1. Войди в Битрикс24: `https://ваш-домен.bitrix24.ru`
2. Открой меню (☰) слева вверху
3. Нажми **CRM**
4. Нажми **Настройки** (⚙️ справа вверху)
5. Выбери **Настройка полей**
6. Выбери **Сделка**

### 3.2 Создай первое поле: UID сметы

1. Нажми **+ Добавить пользовательское поле**
2. Заполни:
   - **Название поля**: `UID сметы`
   - **Тип**: `Строка`
   - **Символьный код**: `UF_CRM_SMETA_UID`
3. Нажми **Сохранить**

### 3.3 Создай второе поле: Ссылка на смету

1. Нажми **+ Добавить пользовательское поле**
2. Заполни:
   - **Название поля**: `Ссылка на смету`
   - **Тип**: `Ссылка`
   - **Символьный код**: `UF_CRM_SMETA_LINK`
3. Нажми **Сохранить**

### 3.4 Создай третье поле: Папка клиента

1. Нажми **+ Добавить пользовательское поле**
2. Заполни:
   - **Название поля**: `Папка клиента`
   - **Тип**: `Ссылка`
   - **Символьный код**: `UF_CRM_FOLDER_LINK`
3. Нажми **Сохранить**

---

## 📋 ШАГ 4: Настройка Битрикс24 — Вебхуки (5 минут)

### 4.1 Создай ВХОДЯЩИЙ вебхук (для получения результата)

1. Открой меню (☰) → **Приложения** → **Вебхуки**
2. Нажми вкладку **Входящий вебхук**
3. Нажми **+ Добавить вебхук**
4. В разделе **Права доступа** поставь галочки:
   - ✅ **CRM (crm)**
5. Нажми **Сохранить**
6. **СКОПИРУЙ URL** (он выглядит так):

```
https://ваш-домен.bitrix24.ru/rest/1/abc123xyz456/
```

7. **СОХРАНИ ЭТО В БЛОКНОТ** — понадобится в шаге 4.2

### 4.2 Создай ИСХОДЯЩИЙ вебхук (для отправки данных)

1. Нажми вкладку **Исходящий вебхук**
2. Нажми **+ Добавить вебхук**
3. Заполни:

#### Основная информация:
- **Название**: `Создание сметы в Google`
- **URL обработчика**: 

```
https://script.google.com/macros/s/AKfycbyjJDkB9_8W8rQKhADQXllx9doq82rFl5o2GUOt_qECzdk_HIyaoY5uJtbACW4A1RzE/exec
```

#### Событие:
- **Событие**: `При обновлении сделки` (ONCRMDEALUPDATE)

#### Фильтр:
- **Добавь фильтр**: Стадия = "Делаем смету" (или ID стадии, например `C5:PREPARATION`)

#### Тело запроса:
**ВАЖНО! Выбери формат: JSON**

Скопируй и вставь этот JSON (замени `YOUR_WEBHOOK_URL` на URL из шага 4.1):

```json
{
  "bitrixDealId": "{=Document:ID}",
  "client": "{=Document:TITLE}",
  "address": "{=Document:UF_CRM_ADDRESS}",
  "phone": "{=Document:PHONE[0].VALUE}",
  "bitrixWebhookUrl": "https://ваш-домен.bitrix24.ru/rest/1/abc123xyz456/"
}
```

**Замени последнюю строку** на свой URL из шага 4.1!

4. Нажми **Сохранить**

---

## 📋 ШАГ 5: Создай поле "Адрес" в Битрикс (если нет)

### 5.1 Проверь, есть ли поле "Адрес"

1. Открой любую сделку
2. Посмотри, есть ли поле **"Адрес"** или **"UF_CRM_ADDRESS"**
3. Если **НЕТ** — продолжай шаг 5.2
4. Если **ЕСТЬ** — переходи к шагу 6

### 5.2 Создай поле "Адрес" (если нужно)

1. **CRM → Настройки → Настройка полей → Сделка**
2. Нажми **+ Добавить пользовательское поле**
3. Заполни:
   - **Название**: `Адрес объекта`
   - **Тип**: `Строка` (или `Адрес`, если есть)
   - **Символьный код**: `UF_CRM_ADDRESS`
4. Нажми **Сохранить**

---

## 📋 ШАГ 6: ТЕСТИРОВАНИЕ (2 минуты)

### 6.1 Подготовь тестовую сделку

1. Открой **CRM → Сделки**
2. Создай новую сделку или открой существующую
3. Заполни:
   - **Название**: `Тестовый Клиент`
   - **Телефон**: `+7 999 111 22 33`
   - **Адрес объекта**: `Москва, ул. Тестовая, д. 1`

### 6.2 Запусти создание сметы

1. Переведи сделку в стадию **"Делаем смету"**
2. Подожди **5-10 секунд**
3. Обнови страницу (F5)

### 6.3 Проверь результат

Должны заполниться поля:
- ✅ **UID сметы**: `BITRIX-12345` (где 12345 — ID сделки)
- ✅ **Ссылка на смету**: кликабельная ссылка на Google Sheets
- ✅ **Папка клиента**: кликабельная ссылка на Google Drive

### 6.4 Проверь смету

1. Кликни на **"Ссылка на смету"**
2. Откроется Google Sheets с заполненными данными:
   - UID
   - Имя клиента
   - Телефон
   - Адрес
   - Замерщик
   - Компания

---

## ✅ ГОТОВО!

Теперь при переводе сделки в стадию "Делаем смету" автоматически:
1. 📁 Создаётся папка в Google Drive
2. 📊 Копируется и заполняется смета
3. 👤 Выдаётся доступ замерщику
4. 🔗 Ссылки возвращаются в Битрикс

---

## 🐛 Что делать, если не работает

### Проблема: Поля в Битриксе не обновляются

**Решение:**
1. Открой **Приложения → Вебхуки → История вызовов**
2. Найди последний запрос
3. Посмотри **код ответа**:
   - ✅ **200** — всё хорошо, возможно нужно дольше подождать
   - ❌ **401/403** — проблема с доступом, пересоздай деплой
   - ❌ **500** — ошибка в скрипте, проверь логи GAS

### Проблема: Ошибка "managerFolderId пуст"

**Решение:**
1. Открой таблицу → лист **"Тех"**
2. Проверь, что в ячейке **L6** указан ID папки
3. Проверь, что ID правильный (скопирован из URL)

### Проблема: Ошибка "templateId пуст"

**Решение:**
1. Открой таблицу → лист **"Тех"**
2. Проверь, что в ячейке **L2** указан ID шаблона
3. Проверь, что шаблон не удалён

### Проблема: Ошибка "measurerEmail пуст"

**Решение:**
1. Открой таблицу → лист **"Тех"**
2. Проверь, что в ячейке **L7** указан email
3. Проверь, что email правильный (без пробелов)

---

## 📞 Дополнительная помощь

### Логи Google Apps Script

1. Открой: https://script.google.com/home/projects/1EQiHV_ehdInMzIPRz_SKw63gvD0_XTwqHsGHCQdmsh6RSWjFU_fOwXwI
2. Нажми **Выполнение** (слева)
3. Посмотри последние запуски — там будут ошибки (если есть)

### Логи Битрикс24

1. **Приложения → Вебхуки → История вызовов**
2. Найди последний запрос
3. Посмотри **Ответ** — там будет сообщение об ошибке

---

## 📚 Дополнительные материалы

- [Полная документация](BITRIX_INTEGRATION.md)
- [Быстрый старт](QUICKSTART.md)
- [README проекта](README.md)

---

**Готово!** Если что-то не понятно — пиши, помогу разобраться! 🚀
